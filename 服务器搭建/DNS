
五 DNS
	
	DNS服务器原本是一台中央服务器,因为互联网的发展,DNS服务器发展为一种层级结构,即每一个网域都有自己的DNS服务器,每个DNS服务器有个自己的网域数据库(BIND数据库软件),用于自主记录本网域的"资源记录".
	postfix要搭配DNS服务器.postfix跨网域投递邮件时,必须层层向上层DNS找到目标网域,再在目标网域的DNS服务器找到此网域中的MX主机,进行投递.

	1. DNS的配置
		***有些文章说,需要"为/etc/sysconfig/named增加一行OPTIONS="-4",表示只支持IPv4",但实际测试好像不需要***
		1)配置/etc/named.conf,注释掉IPv6行,注释掉"."这个zone;
		2)配置/etc/named.rfc1912.zone,添加一个正向解析zone文件项,以及反向解析zone文件项,每个文件项都代表一个网域.(一个DNS可负责多个网域的解析)
		3)根据第2)步中添加的文件项,在/var/named/中添加对应的"资源记录"文件;因为每个文件对应一个网域,所以里面的每条记录都是此网域内一个主机或其它资源.
		4)在本地网域"资源记录"文件中,将根域及其它网域的项删除,这样当DNS服务器遇到非本网域的DNS资源,就会自动将其查询转发给ISP或其它DNS服务器.(DNS服务器本身的首选DNS设置为internate的DNS,这样就会自动转发)


		*************************************************************************
		  经过测试,在client端,网关的设定不会影响到DNS服务器设定的效果,代理服务器则会影响.
		  需要在代理服务器的"Ignore"选项中填写"www.si.cn"
		*************************************************************************




	2. 标准的资源记录具有其基本格式：[name]　　　[ttl]　　　IN　　type　　rdata
		1) name:本网域中某条"资源记录"对应的域对象名，可以是一台单独的主机也可以是整个域。字段值："."是根域，@是默认域($ORIGIN,没有的话就是当前域,即named.conf里的zone名称).
		书写规范为:要以"."结束(表示根域对象,类似于绝对路径),否则在解析时会自动在后面加上"@"(表示本域对象,类似于相对路径),例如:
			a)www IN CNAME lalala 等于 www.si.cn. IN CNAME lalala.si.cn.
			b)10 IN PTR lalala.si.cn. 等于 10.10.168.192.in-arpa. IN PTR lalala.si.cn. (PTR 资源项只能在反向解析区域文件中.)

		2) ttl：生存时间字段，它以秒为单位定义该资源记录中的信息存放在DNS缓存中的时间长度。通常此字段值为空，表示采用SOA记录中的最小TTL值(即1小时)。
		3) IN：此字段用于将当前湖泊记录标识为一个INTERNET的DNS资源记录。
		4) TYPE：类型字段，用于标识当前资源记录的类型。
		5) radata: 数据字段用于指定与当前资源记录有关的数据，数据字段的内容取决于类型字段。
		
		注释符号为";"


	2. DNS的网域数据由多种类型的"资源记录"组成,主要以下七种"资源记录":
		
		1)SOA (每个区域文件的第一条记录,指明该区域的主DNS服务器)
		SOA记录即起始授权机构记录,(表示此DNS主机是本域的主DNS服务器,可包含对子域DNS的授权? )指明区域名称，区域主DNS服务器, 以及该区域的其他基本属性。
		五个字段分别为 [本地域名] [ttl省略] [IN] [SOA] [主DNS的主机名+域名 管理者邮件 其它五个参数]
 		例如SOA里面的管理者邮件一般应当写成：root.lalala.si.cn. 而不是root@lalala.si.cn(主要是避免使用"@") 	

		2)NS (每个区域文件不可或缺的记录)
		NS记录也叫名称服务器记录，用于说明这个区域有哪些DNS服务器负责解析.NS指明的都是权威DNS服务器.
			a) 从上层DNS得到授权:
			假設注册的domain叫abc.com, 域内有ns1与ns2兩台server。那必需先从上层的.com权威服务器授权： 
				$ORIGIN com.
				abc IN NS ns1.abc.com.
				abc IN NS ns2.abc.com.
				ns1.abc IN A 1.2.3.4
				ns1.abc IN A 1.2.3.5
			b) 域内自己授权
				$ORIGIN abc.com.
				@ IN NS ns1.abc.com.
				@ IN NS ns2.abc.com.
				@ IN NS ns3.abc.com. (这一条只能对本域内的DNS请求有效,外网的找不到这条记录,因为上层的DNS中没有)
				ns1 IN A 1.2.3.4
				ns2 IN A 1.2.3.5
				ns3 IN A 1.2.3.6
			c)向下级子域DNS授权
				$ORIGIN abc.com.
				sub1 IN NS ns1.sub1.abc.com.
				sub1 IN NS ns2.sub1.abc.com.
				ns1.sub1 IN A 4.3.2.1
				ns2.sub1 IN A 4.3.2.2


		3) A
		代表"主机名称"与"IP地址"的对应关系;

		4)CNAME
		代表"别名"与实际提供服务的"规范主机"名称的对应关系,比如"www.163.com"为对外公布的主机别名,但它可以实际指向某一台提供服务的主机.

		5)MX
		代表本网域的邮件交换主机,由于处理本网域的邮件收发.

		6)PTR
		与A记录相反,代表"IP地址"到"主机名称"的对应关系.PTR记录必须放在反向解析的zone文件中.

		7)SRV
		服务器资源记录,好像是windows的域控制器需要依赖DNS的SRV记录,具体有待研究.

	3.设定MTA的DNS网域数据库时,必须:
		1)包含所有主机的A记录
		2)用上面的主机名(非别名)列出相应的邮件服务器.(因为主机名称可以灵活地对应IP地址)
		3)确定MX的优先值.


	4. 寄出邮件时,postfix使用系统的resolver(即DNS client,负责向本网域的DNS server查询网域信息的函数库)来取得DNS信息.收信时,你的网域DNS必须要能提供递送信息(MX记录)给外界查询,让其它MTA能够找到你的postfix server.
	smtp MDA对DNS的访问有两次,先查MX主机,再查MX主机的IP,两步都是必须的.
	postfix的转发只存在于备用MTA中,备用MTA定时查探到有优先级更高的MTA启动了,就将邮件都转发给它.

	5. 要让postfix可以代某网域收下所有的邮件,首先要成为此网域的MX记录,另外还需要设定为可以代此网域收邮件(可设定为三种:本地网域通过mydestination设定;转发通过relay domains设定;虚拟网域...)

	
